<!DOCTYPE html>
<html>
<head>
  <title>re_corder</title>
  <script src="re_corder.js"></script>
  <script>
    var re_corder = null;

    function midi_setup(midi_access) {
      const selector = document.querySelector('#input-port-selector');
      const none_option = document.createElement('option');
      none_option.textContent = 'None';
      selector.appendChild(none_option);
      midi_access.inputs.forEach(input => {
        const option = document.createElement('option');
        option.value = input.id;
        option.textContent = input.name;
        selector.appendChild(option);
      });
      selector.addEventListener('change', event => {
        if (re_corder != null) {
          re_corder.close();
          re_corder = null;
        }
        if (event.target.selectedIndex > 0) {
          const input_id = event.target.value;
          const input = midi_access.inputs.get(input_id);
          const input_name = input.name;
          for (const output of midi_access.outputs.values()) {
            if (output.name === input_name) {
              re_corder = new ReCorder(input, output);
              break;
            }
          }
        }
      });
    }

    function channel_setup() {
      const channels = document.querySelector('#midi-channel-selector');
      const option = document.createElement('option');
      option.value = 0;
      option.text = '--';
      channels.appendChild(option);
      for (let i = 1; i <= 16; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.text = i;
        channels.appendChild(option);
      }
      channels.addEventListener('change', e =>
        re_corder.set_midi_channel(e.target.selectedIndex)
          .then(() => alert('Success!'))
          .catch(() => alert('Request failed! Try holding Record, perhaps?')));
    }

    function user_mode_setup() {
      const user_modes = document.querySelector('#user-mode-selector');
      const option = document.createElement('option');
      option.value = 0;
      option.text = '--';
      user_modes.appendChild(option);
      for (const [key, value] of Object.entries(USER_MODES)) {
        const option = document.createElement('option');
        option.value = key;
        option.text = value;
        user_modes.appendChild(option);
      }
      user_modes.addEventListener('change', e => {
        re_corder.set_user_mode(USER_MODES[e.target.selectedIndex])
          .then(() => alert('Success!'))
          .catch(() => alert('Request failed! Try holding Record, perhaps?'));});
    }

    function select_channel(ch) {
      const channels = document.querySelector('#midi-channel-selector');
      channels.selectedIndex = ch;
    }

    function select_user_mode(mode) {
      const user_modes = document.querySelector('#user-mode-selector');
      user_modes.selectedIndex = find_key(USER_MODES, mode);
    }

    window.addEventListener('load', () => {
      navigator.requestMIDIAccess({sysex: true, software: true})
        .then(midi_access => midi_setup(midi_access));
      channel_setup();
      user_mode_setup();
    });
  </script>
</head>
<body>
  <p>
    MIDI Port <select id="input-port-selector"></select>
  </p>
  <p>
  <button onclick="re_corder.get_midi_channel().then(ch => select_channel(ch)).catch(err => alert(err));">Get MIDI Channel</button>
    <select id="midi-channel-selector"></select>
  </p>
  <p>
  <button onclick="re_corder.get_user_mode().then(mode => select_user_mode(mode)).catch(err => alert(err));">Get User Mode</button>
    <select id="user-mode-selector"></select>
  </p>
</body>
</html>
