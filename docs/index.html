<!DOCTYPE html>
<html>
<head>
  <title>re_corder</title>
  <script src="re_corder.js"></script>
  <script>
    var re_corder = undefined;

    async function midi_setup(midi_access) {
      const selector = document.querySelector('#input-port-selector');
      const none_option = document.createElement('option');
      none_option.textContent = 'None';
      selector.appendChild(none_option);
      midi_access.inputs.forEach(input => {
        const option = document.createElement('option');
        option.value = input.name;
        option.textContent = input.name;
        selector.appendChild(option);
      });
      selector.addEventListener('change', event => {
        if (re_corder) {
          re_corder.close();
          re_corder = undefined;
        }
        if (event.target.selectedIndex > 0) {
          const input_name = event.target.value;
          re_corder = create_re_corder(midi_access, input_name);
          console.log(`Created ${re_corder}.`);
        }
      });
    }

    function channel_setup() {
      const channels = document.querySelector('#midi-channel-selector');
      const option = document.createElement('option');
      option.value = 0;
      option.text = '--';
      channels.appendChild(option);
      for (let i = 1; i <= 16; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.text = i;
        channels.appendChild(option);
      }
      channels.addEventListener('change', e =>
        re_corder.set_midi_channel(e.target.selectedIndex)
          .then(() => alert('Success!'))
          .catch(() => alert('Request failed! Try holding Record, perhaps?'))
      );
    }

    function get_midi_channel() {
      const channels = document.querySelector('#midi-channel-selector');
      re_corder.get_midi_channel()
        .then(ch => channels.selectedIndex = ch)
        .catch(err => alert(err));
    }

    function log_config() {
      re_corder.get_user_mode()
        .then(m => console.log(`user mode: ${m}`));
      re_corder.get_midi_channel()
        .then(ch => console.log(`midi channel: ${ch}`));
      re_corder.get_easy_connect_status()
        .then(s => console.log(`easy connect: ${s}`));
      re_corder.get_smoothing()
        .then(s => console.log(s));
      re_corder.get_sensitivity()
        .then(s => console.log(s));
      re_corder.get_controller_config()
        .then(c => console.log(c));
      re_corder.get_battery_state()
        .then(b => console.log(`battery: ${b}`));
    }

    window.addEventListener('load', () => {
      navigator.requestMIDIAccess({sysex: true, software: true})
        .then(midi_access => midi_setup(midi_access));
      channel_setup();
    });
  </script>
</head>
<body>
  <p>
    MIDI Port <select id="input-port-selector"></select>
  </p>
  <p>
  <button onclick="get_midi_channel();">Get MIDI Channel</button>
    <select id="midi-channel-selector"></select>
  </p>
  <p>
  <button onclick="log_config();">Log Config</button>
  </p>
</body>
</html>
