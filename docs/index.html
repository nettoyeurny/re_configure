<!DOCTYPE html>
<html>
<head>
  <title>Re.Configure</title>
  <script src="re_corder.js"></script>
  <script>
    var re_corder = undefined;

    const enable_buttons = enabled => {
      const buttons = document.querySelectorAll('button');
      for (const button of buttons) {
        button.disabled = !enabled;
      }
    }

    const log_button = (data) => {
      console.log(`Re.corder button: ${data}`);
    }

    const log_note_event = e => {
      const data = e.data;
      if (!(data[0] & 0x60)) {
        console.log(`MIDI note event: ${to_hex(data)}`);
      }
    }

    const midi_setup = async (midi_access) => {
      const selector = document.querySelector('#input-port-selector');
      const none_option = document.createElement('option');
      none_option.textContent = 'None';
      selector.appendChild(none_option);
      midi_access.inputs.forEach(input => {
        const option = document.createElement('option');
        option.value = input.name;
        option.textContent = input.name;
        selector.appendChild(option);
      });
      selector.addEventListener('change', event => {
        if (re_corder) {
          enable_buttons(false);
          re_corder.close();
          re_corder = undefined;
        }
        if (event.target.selectedIndex > 0) {
          const input_name = event.target.value;
          create_re_corder(
              midi_access, input_name, log_button, log_note_event)
            .then(r => {
              re_corder = r;
              return r.get_battery_state();
            })
            .then(b => {
              enable_buttons(true);
              alert(`Found re.corder. Battery level: ${b}`);
            })
            .catch(err => alert(`${err} --- Wrong port, perhaps?`));
        }
      });
    }

    const get_config = () => {
      const text_area = document.getElementById('re_corder-config');
      get_re_corder_config(re_corder)
        .then(conf => text_area.value = JSON.stringify(conf, null, 2))
        .catch(err => alert(err));
    }

    const set_config = () => {
      const text_area = document.getElementById('re_corder-config');
      set_re_corder_config(re_corder, JSON.parse(text_area.value))
        .then(conf => text_area.value = JSON.stringify(conf, null, 2))
        .then(() => alert('Success!'))
        .catch(err => alert(`${err} --- Try holding Record, perhaps?`));
    }

    const restore_default = () => {
      const text_area = document.getElementById('re_corder-config');
      re_corder.restore_default_settings()
        .then(() => get_re_corder_config(re_corder))
        .then(conf => text_area.value = JSON.stringify(conf, null, 2))
        .catch(err => alert(`${err} --- Try holding Record, perhaps?`));
    }

    const set_fingerings = () => {
      const text_area = document.getElementById('re_corder-fingerings');
      set_re_corder_fingerings(re_corder, JSON.parse(text_area.value))
        .then(() => alert('Success!'))
        .catch(err => alert(err));
    }

    const set_keyboard_chart = () => {
      const text_area = document.getElementById('re_corder-keyboard');
      set_re_corder_keyboard(re_corder, JSON.parse(text_area.value))
        .then(() => alert('Success!'))
        .catch(err => alert(err));
    }

    window.addEventListener('load', () => {
      enable_buttons(false);
      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess({sysex: true, software: true})
          .then(midi_access => midi_setup(midi_access))
          .catch(_ => alert('Failed to get MIDI access!'));
      } else {
        alert('This browser does not support Web MIDI!');
      }
    });
  </script>
</head>
<body>
  <h1>Re.Configure</h1>
  <p>
    <a href="https://github.com/nettoyeurny/re_configure">Documentation and source code</a>
  </p>
  <p>
    Re.corder Port: <select id="input-port-selector"></select>
  </p>
  <h2>Re.corder Configuration</h2>
  <p>
    <ul>
      <li>user_mode: "Breath", "Lip", "Keyboard"</li>
      <li>midi_channel: 1-16</li>
      <li>threshold: 601-16383</li>
      <li>velocity: 0-127</li>
      <li>aftertouch, curve: "None", "Linear", "Emb1"-"Emb20"</li>
      <li>ctrl: 0-127</li>
      <li>easy_connect: true, false</li>
      <li>maintain_note: true, false</li>
      <li>smooth_acc: 0-4</li>
    </ul>
  </p>
  <p>
    <button onclick="get_config();">Get Config</button>
    <button onclick="set_config();">Set Config</button>
    <button onclick="restore_default();">Restore Default</button>
    <br>
    <textarea id="re_corder-config" rows="28" cols="32"></textarea>
  </p>
  <h2>Fingering Chart</h2>
  <p>
    A fingering chart is a list of the form
    <pre>
        [
          ...
          [ "G5",  "*.***.oooo" ],
          [ "G#5", "*.**o.**@o" ],
          [ "A5",  "*.**o.oooo" ],
          ...
        ]
    </pre>
    where each item specifies a note and a string representing a fingering to be
    read from left to right (left thumb to right pinkie), where `o/*/@` stands
    for an open/closed/partially closed hole, with optional dots for
    readability. In addition, the letter `e` specifies a partially closed hole
    in the opposite way (e.g., for left-handed fingerings).
  </p>
  <p>
    <button onclick="set_fingerings();">Set Fingering Chart</button>
    <br>
    <textarea id="re_corder-fingerings" rows="28" cols="32">
[
  [ "C5",  "*.***.****" ],
  [ "C#5", "*.***.***@" ],
  [ "D5",  "*.***.***o" ],
  [ "D#5", "*.***.**@o" ],
  [ "E5",  "*.***.**oo" ],
  [ "F5",  "*.***.*o*o" ],
  [ "F5",  "*.***.*o**" ],
  [ "F5",  "*.***.*o*@" ],
  [ "F#5", "*.***.o**o" ],
  [ "F#5", "*.***.o**@" ],
  [ "F#5", "*.***.o*oo" ],
  [ "G5",  "*.***.oooo" ],
  [ "G#5", "*.**o.***o" ],
  [ "G#5", "*.**o.**oo" ],
  [ "G#5", "*.**o.**@o" ],
  [ "A5",  "*.**o.oooo" ],
  [ "A#5", "*.*o*.*ooo" ],
  [ "A#5", "*.o**.*ooo" ],
  [ "A#5", "*.*o*.oooo" ],
  [ "A#5", "*.*o*.o**o" ],
  [ "B5",  "*.*oo.oooo" ],
  [ "B5",  "*.o**.oooo" ],
  [ "C6",  "*.o*o.oooo" ],
  [ "C6",  "o.***.oooo" ],
  [ "C#6", "o.**o.oooo" ],
  [ "C#6", "*.ooo.oooo" ],
  [ "D6",  "o.o*o.oooo" ],
  [ "D6",  "o.***.****" ],
  [ "D#6", "o.o**.***o" ],
  [ "D#6", "@.***.**@o" ],
  [ "D#6", "o.***.***o" ],
  [ "E6",  "@.***.**oo" ],
  [ "E6",  "o.***.**oo" ],
  [ "E6",  "o.o**.**oo" ],
  [ "F6",  "@.***.*o*o" ],
  [ "F6",  "@.***.*o@o" ],
  [ "F6",  "o.o**.*o@o" ],
  [ "F#6", "@.***.o*oo" ],
  [ "G6",  "@.***.oooo" ],
  [ "G#6", "@.**o.*ooo" ],
  [ "G#6", "@.***.oo**" ],
  [ "A6",  "@.**o.oooo" ],
  [ "A#6", "@.**o.***o" ],
  [ "A#6", "@.**o.o**o" ],
  [ "B6",  "@.**o.**oo" ],
  [ "C7",  "@.*oo.**oo" ],
  [ "C#7", "@.*o*.*oo*" ],
  [ "C#7", "@.*o*.**o*" ],
  [ "C#7", "@.*o*.****" ],
  [ "D7",  "@.*o*.*o*o" ],
  [ "D7",  "@.*o*.*o**" ],
  [ "D7",  "@.*o*.*o*@" ],
  [ "D7",  "@.*oo.*o**" ],
  [ "D7",  "@.*oo.*oo*" ]
]
    </textarea>
  </p>
  <h2>Keyboard Chart</h2>
  <p>
    A keyboard chart is simply a list of notes corresponding to the holes on top of the
    re.corder, sorted from left to right.
  </p>
  <p>
    <button onclick="set_keyboard_chart();">Set Keyboard Chart</button>
    <br>
    <textarea id="re_corder-keyboard" rows="12" cols="32">
[
  "C5",
  "D5",
  "D#5",
  "F5",
  "G5",
  "G#5",
  "A#5",
  "C6",
  "D6"
]
    </textarea>
  </p>
</body>
</html>
