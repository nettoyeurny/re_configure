<!DOCTYPE html>
<html>
<head>
  <title>Re.Configure</title>
  <script src="re_corder.js"></script>
  <script>
    var re_corder = null;

    const TYPES = [{
      description: 'JSON File',
      accept: {'application/json': ['.json']}
    }];

    const enable_re_corder_elements = enabled => {
      const elts = document.getElementsByClassName('re_corder');
      for (const elt of elts) {
        elt.disabled = !enabled;
      }
    }

    const log_button = data => {
      console.log(`Re.corder button: ${data}`);
    }

    const log_note_event = e => {
      const data = e.data;
      if (!(data[0] & 0x60)) {
        console.log(`MIDI note event: ${to_hex(data)}`);
      }
    }

    const monitor_connection = () => {
      const label = document.getElementById('re_corder-state');
      if (re_corder) {
        re_corder.get_battery_state()
          .then(b => label.innerText =
            `Battery: ${Math.max(Math.min(
              Math.round((b - 3200) / 8), 100), 0)}%`)
          .catch(() => label.innerText = 'No connection.');
      } else {
        label.innerText = 'No connection.';
      }
    }

    const midi_setup = midi_access => {
      const selector = document.querySelector('#input-port-selector');
      const none_option = document.createElement('option');
      none_option.textContent = 'None';
      selector.appendChild(none_option);
      midi_access.inputs.forEach(input => {
        const option = document.createElement('option');
        option.value = input.name;
        option.textContent = input.name;
        selector.appendChild(option);
      });
      selector.addEventListener('change', event => {
        if (re_corder) {
          enable_re_corder_elements(false);
          re_corder.close();
          re_corder = null;
        }
        if (event.target.selectedIndex > 0) {
          const input_name = event.target.value;
          create_re_corder(
              midi_access, input_name, log_button, log_note_event)
            .then(r => {
              re_corder = r;
              return r.get_midi_channel();
            })
            .then(() => enable_re_corder_elements(true))
            .catch(err => alert(`${err} --- Wrong port, perhaps?`));
        }
      });
    }

    const get_config = () => {
      const text_area = document.getElementById('re_corder-config');
      get_re_corder_config(re_corder)
        .then(conf => text_area.value = JSON.stringify(conf, null, 2))
        .catch(alert);
    }

    const set_config = () => {
      const text_area = document.getElementById('re_corder-config');
      try {
        set_re_corder_config(re_corder, JSON.parse(text_area.value))
          .then(conf => text_area.value = JSON.stringify(conf, null, 2))
          .then(() => alert('Success!'))
          .catch(err => alert(`${err} --- Try holding Record, perhaps?`));
      } catch(err) {
        alert(err);
      }
    }

    const restore_default = () => {
      const text_area = document.getElementById('re_corder-config');
      re_corder.restore_default_settings()
        .then(() => get_re_corder_config(re_corder))
        .then(conf => text_area.value = JSON.stringify(conf, null, 2))
        .catch(err => alert(`${err} --- Try holding Record, perhaps?`));
    }

    const get_fingerings = () => {
      const text_area = document.getElementById('re_corder-fingerings');
      get_re_corder_fingerings(re_corder)
        .then(f => text_area.value = JSON.stringify(f, null, 2))
        .catch(alert);
    }

    const set_fingerings = () => {
      const text_area = document.getElementById('re_corder-fingerings');
      try {
        set_re_corder_fingerings(re_corder, JSON.parse(text_area.value))
          .then(() => alert('Success!'))
          .catch(alert);
      } catch(err) {
        alert(err);
      }
    }

    const get_keyboard_chart = () => {
      const text_area = document.getElementById('re_corder-keyboard');
      get_re_corder_keyboard(re_corder)
        .then(k => text_area.value = JSON.stringify(k, null, 2))
        .catch(alert);
    }

    const set_keyboard_chart = () => {
      const text_area = document.getElementById('re_corder-keyboard');
      try {
        set_re_corder_keyboard(re_corder, JSON.parse(text_area.value))
          .then(() => alert('Success!'))
          .catch(alert);
      } catch(err) {
        alert(err);
      }
    }

    const read_file = async h => {
      const f = await h.getFile();
      return f.text();
    }

    const write_file = async (f, s) => {
      const w = await f.createWritable();
      await w.write(s);
      w.close();
    }

    const load_contents = id => {
      const text_area = document.getElementById(id);
      const opts = {types: TYPES};
      window.showOpenFilePicker(opts)
        .then(f => read_file(f[0]))
        .then(s => text_area.value = s)
        .catch(alert);
    }

    const save_contents = (id, fn) => {
      const text_area = document.getElementById(id);
      const opts = {suggestedName: fn, types: TYPES};
      window.showSaveFilePicker(opts)
        .then(f => write_file(f, text_area.value))
        .catch(alert);
    }

    window.addEventListener('load', () => {
      enable_re_corder_elements(false);
      setInterval(() => monitor_connection(), 1000);
      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess({sysex: true, software: true})
          .then(midi_access => midi_setup(midi_access))
          .catch(() => alert('Failed to get MIDI access!'));
      } else {
        alert('This browser does not support Web MIDI!');
      }
    });
  </script>
</head>
<body>
  <h1>Re.Configure</h1>
  <p>
    Unofficial <a href="https://github.com/nettoyeurny/re_configure">
      configuration tools</a> for <a href="http://www.artinoise.com/">
      Artinoise re.corder</a> --- use at your own risk!
  </p>
  <p>
    <label>Re.corder Port:</label>
    <select id="input-port-selector"></select></label>
    <label id="re_corder-state">No connection.</label>
  </p>
  <h2>Re.corder Configuration</h2>
  <p>
    <ul>
      <li>user_mode: "Breath", "Lip", "Keyboard"</li>
      <li>midi_channel: 1-16</li>
      <li>threshold: 601-16383</li>
      <li>velocity: 0-127</li>
      <li>aftertouch, curve: "None", "Linear", "Emb1"-"Emb20"</li>
      <li>ctrl: 0-127</li>
      <li>easy_connect: true, false</li>
      <li>maintain_note: true, false</li>
      <li>smooth_acc: 0-4</li>
    </ul>
  </p>
  <p>
    <button class="re_corder" onclick="get_config();">Get Config</button>
    <button class="re_corder" onclick="set_config();">Set Config</button>
    <button class="re_corder" onclick="restore_default();">
      Restore Default</button>
    <button onclick="load_contents('re_corder-config');">Open</button>
    <button onclick="save_contents('re_corder-config', 'config.json');">
      Save</button>
    <br>
    <textarea id="re_corder-config" rows="30" cols="48"></textarea>
  </p>
  <h2>Fingering Chart</h2>
  <p>
    A fingering chart is a list of the form
    <pre>
  [
    ...
    [ "G5",  "*.***.oooo" ],
    [ "G#5", "*.**o.**@o" ],
    [ "A5",  "*.**o.oooo" ],
    ...
  ]
    </pre>
    where each item specifies a note and a string representing a fingering to be
    read from left to right (left thumb to right pinkie), where `o/*/@` stands
    for an open/closed/partially closed hole, with optional dots for
    readability. In addition, the letter `e` specifies a partially closed hole
    in the opposite way (e.g., for left-handed fingerings).
  </p>
  <p>
    <button class="re_corder" onclick="get_fingerings();">Get Fingering</button>
    <button class="re_corder" onclick="set_fingerings();">Set Fingering</button>
    <button onclick="load_contents('re_corder-fingerings');">Open</button>
    <button onclick="save_contents('re_corder-fingerings', 'fingerings.json');">
      Save</button>
    <br>
    <textarea id="re_corder-fingerings" rows="30" cols="48"></textarea>
  </p>
  <h2>Keyboard Chart</h2>
  <p>
    A keyboard chart is simply a list of notes corresponding to the holes on
    top of the re.corder, sorted from left to right.
  </p>
  <p>
    <button class="re_corder" onclick="get_keyboard_chart();">
      Get Keyboard</button>
    <button class="re_corder" onclick="set_keyboard_chart();">
      Set Keyboard</button>
    <button onclick="load_contents('re_corder-keyboard');">Open</button>
    <button onclick="save_contents('re_corder-keyboard', 'keyboard.json');">
      Save</button>
    <br>
    <textarea id="re_corder-keyboard" rows="12" cols="48"></textarea>
  </p>
</body>
</html>
