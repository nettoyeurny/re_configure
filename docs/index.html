<!DOCTYPE html>
<html>
<head>
  <title>Re.Configure</title>
  <script src="re_corder.js"></script>
  <script>
    var re_corder = null;

    const enable_buttons = enabled => {
      const buttons = document.querySelectorAll('button');
      for (const button of buttons) {
        button.disabled = !enabled;
      }
    }

    const log_button = data => {
      console.log(`Re.corder button: ${data}`);
    }

    const log_note_event = e => {
      const data = e.data;
      if (!(data[0] & 0x60)) {
        console.log(`MIDI note event: ${to_hex(data)}`);
      }
    }

    const monitor_connection = () => {
      const label = document.getElementById('re_corder-state');
      if (re_corder) {
        re_corder.get_battery_state()
          .then(b => label.innerText =
            `Battery: ${Math.max(Math.min(
              Math.round((b - 3200) / 8), 100), 0)}%`)
          .catch(() => label.innerText = 'No connection.');
      } else {
        label.innerText = 'No connection.';
      }
    }

    const midi_setup = midi_access => {
      const selector = document.querySelector('#input-port-selector');
      const none_option = document.createElement('option');
      none_option.textContent = 'None';
      selector.appendChild(none_option);
      midi_access.inputs.forEach(input => {
        const option = document.createElement('option');
        option.value = input.name;
        option.textContent = input.name;
        selector.appendChild(option);
      });
      selector.addEventListener('change', event => {
        if (re_corder) {
          enable_buttons(false);
          re_corder.close();
          re_corder = null;
        }
        if (event.target.selectedIndex > 0) {
          const input_name = event.target.value;
          create_re_corder(
              midi_access, input_name, log_button, log_note_event)
            .then(r => {
              re_corder = r;
              return r.get_midi_channel();
            })
            .then(() => enable_buttons(true))
            .catch(err => alert(`${err} --- Wrong port, perhaps?`));
        }
      });
    }

    const get_config = () => {
      const text_area = document.getElementById('re_corder-config');
      get_re_corder_config(re_corder)
        .then(conf => text_area.value = JSON.stringify(conf, null, 2))
        .catch(err => alert(err));
    }

    const set_config = () => {
      const text_area = document.getElementById('re_corder-config');
      set_re_corder_config(re_corder, JSON.parse(text_area.value))
        .then(conf => text_area.value = JSON.stringify(conf, null, 2))
        .then(() => alert('Success!'))
        .catch(err => alert(`${err} --- Try holding Record, perhaps?`));
    }

    const restore_default = () => {
      const text_area = document.getElementById('re_corder-config');
      re_corder.restore_default_settings()
        .then(() => get_re_corder_config(re_corder))
        .then(conf => text_area.value = JSON.stringify(conf, null, 2))
        .catch(err => alert(`${err} --- Try holding Record, perhaps?`));
    }

    const get_fingerings = () => {
      const text_area = document.getElementById('re_corder-fingerings');
      get_re_corder_fingerings(re_corder)
        .then(f => text_area.value = JSON.stringify(f, null, 2))
        .catch(err => alert(err));
    }

    const set_fingerings = () => {
      const text_area = document.getElementById('re_corder-fingerings');
      set_re_corder_fingerings(re_corder, JSON.parse(text_area.value))
        .then(() => alert('Success!'))
        .catch(err => alert(err));
    }

    const get_keyboard_chart = () => {
      const text_area = document.getElementById('re_corder-keyboard');
      get_re_corder_keyboard(re_corder)
        .then(k => text_area.value = JSON.stringify(k, null, 2))
        .catch(err => alert(err));
    }

    const set_keyboard_chart = () => {
      const text_area = document.getElementById('re_corder-keyboard');
      set_re_corder_keyboard(re_corder, JSON.parse(text_area.value))
        .then(() => alert('Success!'))
        .catch(err => alert(err));
    }

    window.addEventListener('load', () => {
      enable_buttons(false);
      setInterval(() => monitor_connection(), 1000);
      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess({sysex: true, software: true})
          .then(midi_access => midi_setup(midi_access))
          .catch(() => alert('Failed to get MIDI access!'));
      } else {
        alert('This browser does not support Web MIDI!');
      }
    });
  </script>
</head>
<body>
  <h1>Re.Configure</h1>
  <p>
    <a href="https://github.com/nettoyeurny/re_configure">Documentation and
      source code</a>
  </p>
  <p>
    <label>Re.corder Port:</label>
    <select id="input-port-selector"></select></label>
    <label id="re_corder-state"></label>
  </p>
  <h2>Re.corder Configuration</h2>
  <p>
    <ul>
      <li>user_mode: "Breath", "Lip", "Keyboard"</li>
      <li>midi_channel: 1-16</li>
      <li>threshold: 601-16383</li>
      <li>velocity: 0-127</li>
      <li>aftertouch, curve: "None", "Linear", "Emb1"-"Emb20"</li>
      <li>ctrl: 0-127</li>
      <li>easy_connect: true, false</li>
      <li>maintain_note: true, false</li>
      <li>smooth_acc: 0-4</li>
    </ul>
  </p>
  <p>
    <button onclick="get_config();">Get Config</button>
    <button onclick="set_config();">Set Config</button>
    <button onclick="restore_default();">Restore Default</button>
    <br>
    <textarea id="re_corder-config" rows="28" cols="32"></textarea>
  </p>
  <h2>Fingering Chart</h2>
  <p>
    A fingering chart is a list of the form
    <pre>
  [
    ...
    [ "G5",  "*.***.oooo" ],
    [ "G#5", "*.**o.**@o" ],
    [ "A5",  "*.**o.oooo" ],
    ...
  ]
    </pre>
    where each item specifies a note and a string representing a fingering to be
    read from left to right (left thumb to right pinkie), where `o/*/@` stands
    for an open/closed/partially closed hole, with optional dots for
    readability. In addition, the letter `e` specifies a partially closed hole
    in the opposite way (e.g., for left-handed fingerings).
  </p>
  <p>
    <button onclick="get_fingerings();">Get Fingering</button>
    <button onclick="set_fingerings();">Set Fingering</button>
    <br>
    <textarea id="re_corder-fingerings" rows="28" cols="32"></textarea>
  </p>
  <h2>Keyboard Chart</h2>
  <p>
    A keyboard chart is simply a list of notes corresponding to the holes on
    top of the re.corder, sorted from left to right.
  </p>
  <p>
    <button onclick="get_keyboard_chart();">Get Keyboard</button>
    <button onclick="set_keyboard_chart();">Set Keyboard</button>
    <br>
    <textarea id="re_corder-keyboard" rows="12" cols="32"></textarea>
  </p>
</body>
</html>
